name: reusable-gate

on:
  workflow_call:
    inputs:
      working-directory:
        type: string
        required: false
        default: "."
      tools-ref:
        type: string
        required: false
        default: "main"
      evals-ref:
        type: string
        required: false
        default: "main"
      actions-ref:
        type: string
        required: false
        default: "main"

jobs:
  governance-gate:
    name: governance-gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Checkout aaa-tools
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tools
          ref: ${{ inputs.tools-ref }}
          path: aaa-tools

      - name: Checkout aaa-actions
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-actions
          ref: ${{ inputs.actions-ref }}
          path: aaa-actions

      - name: Checkout aaa-evals
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-evals
          ref: ${{ inputs.evals-ref }}
          path: aaa-evals

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install AAA tools
        run: python3 -m pip install -e ./aaa-tools

      - name: Run governance gate
        working-directory: repo/${{ inputs.working-directory }}
        env:
          AAA_EVALS_ROOT: ${{ github.workspace }}/aaa-evals
          AAA_CHECKS_MANIFEST: ${{ github.workspace }}/aaa-actions/checks.manifest.json
        run: aaa check --mode blocking

      - name: Generate compliance report
        working-directory: repo/${{ inputs.working-directory }}
        env:
          AAA_EVALS_ROOT: ${{ github.workspace }}/aaa-evals
          AAA_CHECKS_MANIFEST: ${{ github.workspace }}/aaa-actions/checks.manifest.json
        run: aaa audit --local --output compliance_report.json
      - name: Normalize compliance report path
        run: |
          SRC="repo/${{ inputs.working-directory }}/compliance_report.json"
          DST="repo/compliance_report.json"
          SRC_REAL=$(realpath "$SRC")
          DST_REAL=$(realpath "$DST")
          if [ "$SRC_REAL" != "$DST_REAL" ]; then
            cp "$SRC" "$DST"
          fi

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: repo/compliance_report.json
          retention-days: 90

      - name: Pack inventory (audit)
        working-directory: repo/${{ inputs.working-directory }}
        run: aaa pack list
