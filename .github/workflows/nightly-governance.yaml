name: nightly-governance
on:
  workflow_call:
    inputs:
      org:
        type: string
        default: ai-asset-architecture

jobs:
  nightly:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          path: aaa-tpl-docs
      - name: Checkout aaa-tools
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tools
          path: aaa-tools
      - name: Checkout aaa-evals
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-evals
          path: aaa-evals
      - name: Checkout aaa-actions
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-actions
          path: aaa-actions
      - name: Checkout aaa-tpl-frontend
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tpl-frontend
          path: aaa-tpl-frontend
      - name: Checkout aaa-tpl-service
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tpl-service
          path: aaa-tpl-service
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install AAA tools
        run: |
          python3 -m pip install -U pip
          python3 -m pip install -e ./aaa-tools
      - name: Prepare report path
        run: |
          REPORT_TS=$(date -u +%Y%m%d_%H%M)
          echo "REPORT_TS=${REPORT_TS}" >> "${GITHUB_ENV}"
          echo "REPORT_PATH=aaa-tpl-docs/reports/audits/nightly_governance_${REPORT_TS}.md" >> "${GITHUB_ENV}"
      - name: Reindex assets (drift check)
        run: |
          aaa run runbook --runbook-file ./aaa-tools/runbooks/ops/reindex-all-assets.yaml
      - name: Org audit
        env:
          GH_TOKEN: ${{ github.token }}
          AAA_TPL_DOCS_DIR: ${{ github.workspace }}/aaa-tpl-docs
        run: |
          python3 ./aaa-evals/runner/run_github_audit.py
      - name: Repo checks (governance)
        env:
          AAA_EVALS_ROOT: ${{ github.workspace }}/aaa-evals
          WORKSPACE_DIR: ${{ github.workspace }}
          AAA_CHECKS_MANIFEST: ${{ github.workspace }}/aaa-actions/checks.manifest.json
        run: |
          mkdir -p /tmp/aaa-nightly
          cat <<'JSON' > /tmp/nightly-plan.json
          {"repos":[{"name":"aaa-tpl-docs","repo_type":"docs"},{"name":"aaa-tpl-service","repo_type":"service"},{"name":"aaa-tpl-frontend","repo_type":"frontend"}]}
          JSON
          {
            echo "# Nightly Governance Report (${REPORT_TS} UTC)"
            echo ""
            echo "## Nightly Test Cases"
            echo "- Reindex Drift Check: aaa run runbook --runbook-file ./aaa-tools/runbooks/ops/reindex-all-assets.yaml"
            echo "  - ZH-TW: 確保索引與實際資產同步，避免治理數據漂移。"
            echo "  - EN: Ensures indexes match real assets to prevent governance drift."
            echo "- Org Audit: python3 ./aaa-evals/runner/run_github_audit.py"
            echo "  - ZH-TW: 組織級治理稽核，檢查分支保護與 required checks 落地。"
            echo "  - EN: Org-level audit for branch protection and required checks compliance."
            echo "- Repo Checks (Governance Suite): aaa init repo-checks --suite governance"
            echo "  - Checks: readme, workflow, repo_type_consistency, checks_manifest_alignment, orphaned_assets"
            echo "  - ZH-TW: 逐 repo 驗證文件與治理規則一致性，避免類型誤判。"
            echo "  - EN: Per-repo governance validation to avoid repo-type mismatches."
            echo "- Agent Safety: python3 ./aaa-evals/runner/run_repo_checks.py --check agent_safety --repo <workspace>"
            echo "  - ZH-TW: 驗證安全攔截與邊界限制是否有效。"
            echo "  - EN: Validates safety blocks and boundary enforcement."
            echo ""
            echo "## Repo Checks (Governance)"
          } > "${REPORT_PATH}"
          aaa init repo-checks \
            --from-plan /tmp/nightly-plan.json \
            --org "${{ inputs.org }}" \
            --suite governance \
            --jsonl --log-dir /tmp/aaa-nightly | tee /tmp/aaa-nightly/repo-checks.jsonl | tee -a "${REPORT_PATH}"
          python3 - <<'PY'
          import json
          from pathlib import Path

          lines = Path("/tmp/aaa-nightly/repo-checks.jsonl").read_text(encoding="utf-8").strip().splitlines()
          repos = []
          for line in lines:
              try:
                  payload = json.loads(line)
              except json.JSONDecodeError:
                  continue
              if payload.get("event") != "result":
                  continue
              data = payload.get("data", {})
              if "repo" in data and "checks" in data:
                  repos.append({
                      "name": data.get("repo"),
                      "repo_type": "unknown",
                      "archived": False,
                      "checks": data.get("checks", []),
                  })
          snapshot = {
              "generated_at": "${REPORT_TS}",
              "org": "${{ inputs.org }}",
              "repo_count": len(repos),
              "compliance_rate": 0.0,
              "repos": repos,
          }
          Path("/tmp/aaa-nightly/nightly_governance.json").write_text(json.dumps(snapshot, indent=2), encoding="utf-8")
          PY
      - name: Agent safety check
        env:
          AAA_TOOLS_ROOT: ${{ github.workspace }}/aaa-tools
        run: |
          {
            echo ""
            echo "## Agent Safety"
          } >> "${REPORT_PATH}"
          python3 ./aaa-evals/runner/run_repo_checks.py \
            --check agent_safety \
            --repo "${{ github.workspace }}" | tee -a "${REPORT_PATH}"
      - name: Render governance dashboard
        run: |
          mkdir -p aaa-tpl-docs/docs/dashboard
          aaa ops render-dashboard \
            --input /tmp/aaa-nightly/nightly_governance.json \
            --md-out "${REPORT_PATH}" \
            --html-out aaa-tpl-docs/docs/dashboard/index.html \
            --threshold 0.8
      - name: Commit reports
        run: |
          cd aaa-tpl-docs
          if [ -z "$(git status --porcelain)" ]; then
            echo "No report changes."
            exit 0
          fi
          git config user.name "aaa-bot"
          git config user.email "aaa-bot@users.noreply.github.com"
          git add reports docs milestones
          git commit -m "chore: nightly governance reports"
          git push origin HEAD
