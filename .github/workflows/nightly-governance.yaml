name: nightly-governance
on:
  workflow_call:
    inputs:
      org:
        type: string
        default: ai-asset-architecture
      publish_dashboard:
        type: boolean
        default: false

jobs:
  nightly:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout docs repo
        uses: actions/checkout@v4
        with:
          path: aaa-tpl-docs
      - name: Checkout public docs
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-docs
          path: aaa-docs
      - name: Checkout aaa-tools
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tools
          path: aaa-tools
      - name: Checkout aaa-evals
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-evals
          path: aaa-evals
      - name: Checkout aaa-actions
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-actions
          path: aaa-actions
      - name: Checkout aaa-policies
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-policies
          path: aaa-policies
      - name: Checkout aaa-observability
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-observability
          path: aaa-observability
      - name: Checkout asset registry
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/ai-asset-architecture-registry
          path: ai-asset-architecture-registry
      - name: Checkout aaa-prompts
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-prompts
          path: aaa-prompts
      - name: Checkout org profile
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/.github
          path: .github
      - name: Checkout aaa-tpl-frontend
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tpl-frontend
          path: aaa-tpl-frontend
      - name: Checkout aaa-tpl-service
        uses: actions/checkout@v4
        with:
          repository: ai-asset-architecture/aaa-tpl-service
          path: aaa-tpl-service
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install AAA tools
        run: |
          python3 -m pip install -U pip
          python3 -m pip install -e ./aaa-tools
      - name: Prepare report path
        run: |
          REPORT_TS=$(TZ=Asia/Taipei date +%Y%m%d_%H%M)
          echo "REPORT_TS=${REPORT_TS}" >> "${GITHUB_ENV}"
          echo "REPORT_PATH=aaa-tpl-docs/reports/audits/nightly_governance_${REPORT_TS}.md" >> "${GITHUB_ENV}"
      - name: Org audit
        env:
          GH_TOKEN: ${{ github.token }}
          AAA_TPL_DOCS_DIR: ${{ github.workspace }}/aaa-tpl-docs
        run: |
          python3 ./aaa-evals/runner/run_github_audit.py
      - name: Reindex assets (drift check)
        run: |
          aaa run runbook --runbook-file ./aaa-tools/runbooks/ops/reindex-all-assets.yaml --format json
      - name: Repo checks (governance)
        id: repo_checks
        continue-on-error: true
        env:
          AAA_EVALS_ROOT: ${{ github.workspace }}/aaa-evals
          WORKSPACE_DIR: ${{ github.workspace }}
          AAA_CHECKS_MANIFEST: ${{ github.workspace }}/aaa-actions/checks.manifest.json
        run: |
          mkdir -p /tmp/aaa-nightly
          python3 - <<'PY'
          import json
          from pathlib import Path

          map_path = Path("${{ github.workspace }}/aaa-actions/.aaa/repo_type_map.json")
          data = json.loads(map_path.read_text(encoding="utf-8"))
          repo_type_map = data.get("repo_type_map", {})
          expected_repos = [
              "aaa-tools",
              "aaa-actions",
              "aaa-evals",
              "aaa-policies",
              "aaa-observability",
              ".github",
              "ai-asset-architecture-registry",
              "aaa-prompts",
              "aaa-docs",
              "aaa-tpl-docs",
              "aaa-tpl-service",
              "aaa-tpl-frontend",
          ]
          repos = [{"name": name, "repo_type": repo_type_map.get(name, "")} for name in expected_repos]
          Path("/tmp/nightly-plan.json").write_text(json.dumps({"repos": repos}, indent=2), encoding="utf-8")
          print(f"INFO repo_type_map_loaded path={map_path} version={data.get('version')}")
          PY
          {
            echo "# Nightly Governance Report (${REPORT_TS} Asia/Taipei)"
            echo ""
            echo "## Nightly Test Cases"
            echo "- Reindex Drift Check: aaa run runbook --runbook-file ./aaa-tools/runbooks/ops/reindex-all-assets.yaml"
            echo "  - ZH-TW: 確保索引與實際資產同步，避免治理數據漂移。"
            echo "  - EN: Ensures indexes match real assets to prevent governance drift."
            echo "- Dashboard Thresholds: compliance=0.8 drift=0.05 health=0.9"
            echo "  - ZH-TW: 合規率/漂移率/健康度門檻，低於/高於即觸發告警。"
            echo "  - EN: Compliance/drift/health thresholds trigger alerts when breached."
            echo "- Org Audit: python3 ./aaa-evals/runner/run_github_audit.py"
            echo "  - ZH-TW: 組織級治理稽核，檢查分支保護與 required checks 落地。"
            echo "  - EN: Org-level audit for branch protection and required checks compliance."
            echo "- Repo Checks (Governance Suite): aaa init repo-checks --suite governance"
            echo "  - Checks: readme, workflow, repo_type_consistency, checks_manifest_alignment, orphaned_assets"
            echo "  - ZH-TW: 逐 repo 驗證文件與治理規則一致性，避免類型誤判。"
            echo "  - EN: Per-repo governance validation to avoid repo-type mismatches."
            echo "- Agent Safety: python3 ./aaa-evals/runner/run_repo_checks.py --check agent_safety --repo <workspace>"
            echo "  - ZH-TW: 驗證安全攔截與邊界限制是否有效。"
            echo "  - EN: Validates safety blocks and boundary enforcement."
            echo ""
            echo "## Repo Checks (Governance)"
          } > /tmp/nightly_report.md
          set +e
          aaa init repo-checks \
            --from-plan /tmp/nightly-plan.json \
            --org "${{ inputs.org }}" \
            --suite governance \
            --jsonl --log-dir /tmp/aaa-nightly | tee /tmp/aaa-nightly/repo-checks.jsonl | tee -a /tmp/nightly_report.md
          STATUS=${PIPESTATUS[0]}
          set -e
          echo "exit_code=${STATUS}" >> "${GITHUB_OUTPUT}"
          python3 - <<'PY'
          import json
          import os
          from pathlib import Path

          report_ts = os.environ.get("REPORT_TS", "")
          map_path = Path("${{ github.workspace }}/aaa-actions/.aaa/repo_type_map.json")
          map_data = json.loads(map_path.read_text(encoding="utf-8"))
          allowed_types = set(map_data.get("allowed_types", []))
          repo_type_map = map_data.get("repo_type_map", {})
          expected_repos = [
              "aaa-tools",
              "aaa-actions",
              "aaa-evals",
              "aaa-policies",
              "aaa-observability",
              ".github",
              "ai-asset-architecture-registry",
              "aaa-prompts",
              "aaa-docs",
              "aaa-tpl-docs",
              "aaa-tpl-service",
              "aaa-tpl-frontend",
          ]
          plan = json.loads(Path("/tmp/nightly-plan.json").read_text(encoding="utf-8"))
          repo_types = {item.get("name"): item.get("repo_type", "") for item in plan.get("repos", [])}

          lines = Path("/tmp/aaa-nightly/repo-checks.jsonl").read_text(encoding="utf-8").strip().splitlines()
          repos = []
          for line in lines:
              try:
                  payload = json.loads(line)
              except json.JSONDecodeError:
                  continue
              if payload.get("event") != "result":
                  continue
              data = payload.get("data", {})
              if "repo" in data and "checks" in data:
                  repo_name = data.get("repo")
                  repo_type = repo_types.get(repo_name, "")
                  if not repo_type:
                      print(f"ERROR missing_repo_type_mapping repo={repo_name}")
                  elif repo_type not in allowed_types:
                      print(f"WARN unknown_repo_type repo={repo_name} value={repo_type}")
                  repos.append({
                      "name": repo_name,
                      "repo_type": repo_type,
                      "archived": False,
                      "checks": data.get("checks", []),
                  })
          missing = [name for name in expected_repos if name not in repo_type_map]
          if missing:
              for name in missing:
                  print(f"ERROR missing_repo_type_mapping repo={name}")
              raise SystemExit(1)
          coverage = int(100 * (len(expected_repos) - len(missing)) / len(expected_repos)) if expected_repos else 0
          print(f"INFO repo_type_map_coverage={coverage}%")
          snapshot = {
              "generated_at": report_ts,
              "org": "${{ inputs.org }}",
              "repo_count": len(repos),
              "compliance_rate": 0.0,
              "repos": repos,
          }
          Path("/tmp/aaa-nightly/nightly_governance.json").write_text(json.dumps(snapshot, indent=2), encoding="utf-8")
          PY
          mkdir -p aaa-tpl-docs/reports/audits
          cp /tmp/aaa-nightly/nightly_governance.json "aaa-tpl-docs/reports/audits/nightly_governance_${REPORT_TS}.json"
          cp /tmp/aaa-nightly/repo-checks.jsonl "aaa-tpl-docs/reports/audits/repo_checks_${REPORT_TS}.jsonl"
          cat /tmp/nightly_report.md > "${REPORT_PATH}"
      - name: Agent safety check
        env:
          AAA_TOOLS_ROOT: ${{ github.workspace }}/aaa-tools
        run: |
          {
            echo ""
            echo "## Agent Safety"
          } >> "${REPORT_PATH}"
          python3 ./aaa-evals/runner/run_repo_checks.py \
            --check agent_safety \
            --repo "${{ github.workspace }}" | tee -a "${REPORT_PATH}"
      - name: Reindex assets (post-report)
        run: |
          aaa run runbook --runbook-file ./aaa-tools/runbooks/ops/reindex-all-assets.yaml --format json
      - name: Render governance dashboard
        if: ${{ inputs.publish_dashboard }}
        run: |
          mkdir -p aaa-docs/docs/dashboard
          aaa ops render-dashboard \
            --input /tmp/aaa-nightly/nightly_governance.json \
            --md-out "${REPORT_PATH}" \
            --html-out aaa-docs/docs/dashboard/index.html \
            --threshold 0.8 \
            --drift-threshold 0.05 \
            --health-threshold 0.9
      - name: Commit reports
        if: ${{ always() }}
        run: |
          cd aaa-tpl-docs
          if [ -z "$(git status --porcelain)" ]; then
            echo "No report changes."
            exit 0
          fi
          git config user.name "aaa-bot"
          git config user.email "aaa-bot@users.noreply.github.com"
          git add -A
          git commit -m "chore: nightly governance reports"
          git pull --rebase origin main
          git push origin HEAD || (git pull --rebase origin main && git push origin HEAD)
      - name: Commit dashboard
        if: ${{ always() && inputs.publish_dashboard }}
        run: |
          cd aaa-docs
          if [ -z "$(git status --porcelain)" ]; then
            echo "No dashboard changes."
            exit 0
          fi
          git config user.name "aaa-bot"
          git config user.email "aaa-bot@users.noreply.github.com"
          git add docs/dashboard
          git commit -m "chore: update governance dashboard"
          git pull --rebase origin main
          git push origin HEAD || (git pull --rebase origin main && git push origin HEAD)
      - name: Fail if repo checks failed
        if: ${{ steps.repo_checks.outputs.exit_code != '0' }}
        run: |
          echo "Repo checks failed (${{ steps.repo_checks.outputs.exit_code }})."
          exit 1
